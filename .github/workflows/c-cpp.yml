name: Continuous Integration

on:
  push:
    branches: [ "trunk" ]
  pull_request:
    branches: [ "trunk" ]

jobs:
  linux_build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Install SDL
      run: sudo apt -q install libsdl2-dev
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure
    - name: make
      run: make
    - name: make check
      run: make check

  macos_build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3
    - name: Install SDL
      run: brew install sdl2 autoconf automake libtool
    - name: autogen
      run: ./autogen.sh
    - name: configure
      run: ./configure
    - name: make
      run: make

  windows_crossbuild:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Find Git version
      id: version
      run: |
        export VERSION=$(git describe --abbrev=8)
        if [[ ${VERSION:0:1} == "v" ]]; then
          export VERSION=${VERSION:1}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
    - name: Install mingw
      run: sudo apt -q install mingw-w64
    - name: Build SDL
      run: |
        git clone -b SDL2 --depth 1 https://github.com/libsdl-org/SDL.git
        pushd SDL
        mv .git .gitz
        export AUTOTOOLS_BUILD_PATH=build-artifacts
        ./configure --host=i686-w64-mingw32 --prefix=$PWD/../inst \
            --disable-alsa                 \
            --disable-altivec              \
            --disable-arm-neon             \
            --disable-arm-simd             \
            --disable-arts                 \
            --disable-dbus                 \
            --disable-diskaudio            \
            --disable-esd                  \
            --disable-fcitx                \
            --disable-fusionsound          \
            --disable-hidapi-joystick      \
            --disable-hidapi-libusb        \
            --disable-ibus                 \
            --disable-ime                  \
            --disable-jack                 \
            --disable-lasx                 \
            --disable-libdecor             \
            --disable-libsamplerate        \
            --disable-libudev              \
            --disable-lsx                  \
            --disable-nas                  \
            --disable-oss                  \
            --disable-pipewire             \
            --disable-pulseaudio           \
            --disable-render-metal         \
            --disable-sndio                \
            --disable-video-cocoa          \
            --disable-video-directfb       \
            --disable-video-kmsdrm         \
            --disable-video-metal          \
            --disable-video-rpi            \
            --disable-video-vivante        \
            --disable-video-vulkan         \
            --disable-video-wayland        \
            --disable-video-x11
        make -j8
        make install
        popd
    - name: autogen
      run: |
        export PKG_CONFIG_PATH=$PWD/inst/lib/pkgconfig
        ./autogen.sh --host=i686-w64-mingw32
    - name: make
      run: make -j8
    - name: make package
      run: |
        export PATH=$PATH:$PWD/inst/bin
        pushd pkg/win32
        make
        popd
    - name: Upload build
      uses: actions/upload-artifact@v1
      with:
        path: "pkg/win32/staging"
        name: sdl-sopwith-${{steps.version.outputs.VERSION}}-win32
